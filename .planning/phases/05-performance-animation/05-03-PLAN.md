---
phase: 05-performance-animation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/hooks/useAdaptiveFrameRate.ts
  - src/components/Waves.tsx
  - src/App.tsx
  - src/styles/utilities.css
  - src/components/PerformanceIndicator.tsx
  - src/components/PerformanceIndicator.module.css
autonomous: true

must_haves:
  truths:
    - "Users with prefers-reduced-motion see slow, subtle wave animation (5-10x slower)"
    - "Low-performance devices automatically get simplified animations"
    - "Performance indicator shows when in low-power mode"
    - "Wave animations maintain 30fps on mid-tier mobile devices"
    - "fps is dynamically passed from App.tsx through WavyBackground to Waves"
  artifacts:
    - path: "src/hooks/useAdaptiveFrameRate.ts"
      provides: "Frame rate detection and quality level"
      exports: ["useAdaptiveFrameRate"]
    - path: "src/components/PerformanceIndicator.tsx"
      provides: "Visual indicator for performance mode"
      exports: ["PerformanceIndicator"]
    - path: "src/styles/utilities.css"
      provides: "Updated reduced-motion styles (slow instead of disable)"
      contains: "prefers-reduced-motion"
    - path: "src/components/Waves.tsx"
      provides: "Wave component accepting dynamic fps prop"
      contains: "fps.*=.*30"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/usePrefersReducedMotion.ts"
      via: "hook call"
      pattern: "usePrefersReducedMotion\\(\\)"
    - from: "src/App.tsx"
      to: "src/hooks/useAdaptiveFrameRate.ts"
      via: "hook call"
      pattern: "useAdaptiveFrameRate\\(\\)"
    - from: "src/App.tsx"
      to: "src/components/WavyBackground.tsx"
      via: "options.fps prop"
      pattern: "fps:\\s*animationParams\\.fps"
    - from: "src/components/Waves.tsx"
      to: "src/hooks/useAnimationFrame.ts"
      via: "fps prop passed to hook"
      pattern: "useAnimationFrame.*fps"
---

<objective>
Implement reduced motion support and adaptive animation quality for smooth performance across all devices.

Purpose: Honor user accessibility preferences and ensure 60fps animations on all hardware.
Output: Reduced motion shows slow drift (5-10x slower), adaptive frame rate adjusts to device capability, fps dynamically wired from App to Waves.
</objective>

<execution_context>
@/Users/romatroskin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/romatroskin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-animation/05-RESEARCH.md
@.planning/phases/05-performance-animation/05-CONTEXT.md

# Relevant source files
@src/hooks/usePrefersReducedMotion.ts (created in 05-01)
@src/hooks/useAnimationFrame.ts
@src/components/Waves.tsx
@src/components/WavyBackground.tsx
@src/App.tsx
@src/styles/utilities.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAdaptiveFrameRate hook and update utilities.css</name>
  <files>
    - src/hooks/useAdaptiveFrameRate.ts
    - src/styles/utilities.css
  </files>
  <action>
    1. Create src/hooks/useAdaptiveFrameRate.ts following 05-RESEARCH.md pattern:
       - Track frame times using requestAnimationFrame
       - Keep rolling window of last 60 frame deltas
       - Calculate average FPS every 60 frames
       - Return qualityLevel: 'high' | 'medium' | 'low'
       - Thresholds:
         - < 30fps -> 'low'
         - < 45fps -> 'medium'
         - > 55fps -> recover to higher quality
       - Export useAdaptiveFrameRate(targetFPS = 60)

    2. Update src/styles/utilities.css to SLOW animations instead of disabling:
       - Change existing reduced-motion rule from 0.01ms to longer durations
       - Per CONTEXT.md: use 5-10x slower instead of static

       REPLACE:
       ```css
       @media (prefers-reduced-motion: reduce) {
         *,
         *::before,
         *::after {
           animation-duration: 0.01ms !important;
           animation-iteration-count: 1 !important;
           transition-duration: 0.01ms !important;
           scroll-behavior: auto !important;
         }
       }
       ```

       WITH:
       ```css
       @media (prefers-reduced-motion: reduce) {
         *,
         *::before,
         *::after {
           /* Slow animations 10x instead of disabling (per user preference) */
           animation-duration: 3s !important;
           transition-duration: 0.5s !important;
           /* Keep scroll behavior instant for vestibular users */
           scroll-behavior: auto !important;
         }
       }
       ```

       Note: CSS animations affect micro-interactions. Wave animations (JS-based) are handled in App.tsx.
  </action>
  <verify>
    - File exists: src/hooks/useAdaptiveFrameRate.ts
    - Hook exports useAdaptiveFrameRate
    - utilities.css @media rule updated with longer durations
    - `npm run build` succeeds
  </verify>
  <done>
    - useAdaptiveFrameRate hook detects frame rate and returns quality level
    - CSS micro-interactions slow down 10x for reduced-motion preference
    - No animations completely removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Waves.tsx to accept dynamic fps and integrate into App.tsx</name>
  <files>
    - src/components/Waves.tsx
    - src/App.tsx
  </files>
  <action>
    PART A: Update src/components/Waves.tsx to accept fps as a prop

    1. Add fps to WavesPropTypes interface:
       ```typescript
       interface WavesPropTypes {
           points: number;
           speed: number | Interpolation<number, number>;
           amplitude: number | Interpolation<number, number>;
           height: number | Interpolation<number, number>;
           paused: boolean;
           fps?: number;  // ADD THIS - optional, defaults to 30
           svgId?: string;
           svgPathId?: string;
       }
       ```

    2. Extract fps from props with default value:
       ```typescript
       const {
           points = 3,
           speed = 0.1,
           amplitude = 10,
           height = 50,
           paused = false,
           fps = 30,  // ADD THIS - default 30fps
           svgId = "wave",
           svgPathId = "wave-path",
           style,
           fill,
           children,
           id,
           ...rest
       } = props;
       ```

    3. Pass fps to useAnimationFrame (change line ~172):
       BEFORE: `{ fps: 30, paused }`
       AFTER:  `{ fps, paused }`

    4. Also update Waves.tsx to use cachedPerlin2 from Plan 01:
       In calculateWavePoints, change:
       BEFORE: `const noiseValue = noise.perlin2(seed / scale, 1);`
       AFTER:  `const noiseValue = noise.cachedPerlin2(seed / scale, 1);`

    PART B: Update src/App.tsx to use hooks and pass fps dynamically

    1. Import hooks at top:
       ```typescript
       import { usePrefersReducedMotion } from './hooks/usePrefersReducedMotion';
       import { useAdaptiveFrameRate } from './hooks/useAdaptiveFrameRate';
       ```

    2. Add hooks inside App component (after other hooks like useTheme):
       ```typescript
       const prefersReducedMotion = usePrefersReducedMotion();
       const qualityLevel = useAdaptiveFrameRate(60);
       ```

    3. Compute animation parameters based on quality and motion preference:
       ```typescript
       // Animation parameters based on performance and accessibility
       const animationParams = useMemo(() => {
         // Reduced motion: 10x slower animation, minimal movement
         if (prefersReducedMotion) {
           return {
             fps: 3,           // Very slow update rate
             speedMultiplier: 0.1,  // 10x slower speed
             numWaves: 3,      // Fewer waves for simplicity
           };
         }

         // Adaptive based on detected frame rate
         switch (qualityLevel) {
           case 'low':
             return {
               fps: 15,
               speedMultiplier: 0.5,
               numWaves: 3,
             };
           case 'medium':
             return {
               fps: 24,
               speedMultiplier: 0.75,
               numWaves: 4,
             };
           case 'high':
           default:
             return {
               fps: 30,
               speedMultiplier: 1,
               numWaves: 5,
             };
         }
       }, [prefersReducedMotion, qualityLevel]);
       ```

    4. Replace hardcoded `numWaves` constant with `animationParams.numWaves`:
       BEFORE: `const numWaves = 5;`
       AFTER: Remove this line, use `animationParams.numWaves` in useTrail and map

    5. Update useTrail to use dynamic numWaves:
       ```typescript
       const waveConfigs = useTrail(animationParams.numWaves, {
         from: { opacity: 0.3 },
         to: { opacity: 0.7 },
         config: config.gentle,
       });
       ```

    6. Update waveNoiseOffsets to use dynamic numWaves:
       ```typescript
       const waveNoiseOffsets = useMemo(() => {
         return Array.from({ length: animationParams.numWaves }, () => ({
           amplitude: randomRange(-15, 15),
           speed: randomRange(-0.003, 0.003),
           points: randomRange(-0.5, 0.5),
         }));
       }, [animationParams.numWaves]);
       ```

    7. CRITICAL: Pass fps to WavyBackground via options prop:
       ```tsx
       <WavyBackground
         key={index}
         options={{
           height: waveSpring.progress.to(...),
           amplitude: waveSpring.progress.to(...),
           speed: waveSpring.progress.to(
             (p) => (0.015 + p * 0.03 * parallaxMultiplier + speedNoise) * animationParams.speedMultiplier
           ),
           points: 5 + index + pointsNoise,
           paused: false,
           fps: animationParams.fps,  // <-- ADD THIS LINE
         }}
         style={{...}}
         fill={...}
       />
       ```

    8. Apply speedMultiplier to the speed calculations (shown in step 7)

    IMPORTANT: Also reduce parallax effects for accessibility:
    - Update ParallaxLayer speed props to respect reduced motion
    - For reduced motion: multiply speed by 0.1 (almost static)
    - For low quality: multiply speed by 0.5
  </action>
  <verify>
    - Waves.tsx WavesPropTypes includes `fps?: number`
    - Waves.tsx uses `{ fps, paused }` in useAnimationFrame call
    - Waves.tsx uses `noise.cachedPerlin2()` instead of `noise.perlin2()`
    - App.tsx imports both usePrefersReducedMotion and useAdaptiveFrameRate
    - App.tsx has animationParams useMemo with fps, speedMultiplier, numWaves
    - App.tsx WavyBackground options includes `fps: animationParams.fps`
    - `npm run dev` shows waves animating
    - Enabling "Reduce Motion" in OS settings changes animation behavior (slower, fewer waves)
  </verify>
  <done>
    - Waves.tsx accepts dynamic fps prop and uses cached Perlin noise
    - App.tsx uses both accessibility and performance hooks
    - fps flows: animationParams.fps -> WavyBackground options -> Waves props -> useAnimationFrame
    - Reduced motion users see slow, subtle wave drift (3fps, 10x slower speed)
    - Low-performance devices get fewer, slower waves (15fps, 3 waves)
    - Parallax effects reduced for accessibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PerformanceIndicator component</name>
  <files>
    - src/components/PerformanceIndicator.tsx
    - src/components/PerformanceIndicator.module.css
    - src/App.tsx
  </files>
  <action>
    1. Create src/components/PerformanceIndicator.tsx:
       ```typescript
       import styles from './PerformanceIndicator.module.css';

       interface PerformanceIndicatorProps {
         qualityLevel: 'high' | 'medium' | 'low';
         prefersReducedMotion: boolean;
       }

       export function PerformanceIndicator({ qualityLevel, prefersReducedMotion }: PerformanceIndicatorProps) {
         // Only show when not at full quality
         if (qualityLevel === 'high' && !prefersReducedMotion) {
           return null;
         }

         const label = prefersReducedMotion
           ? 'Reduced motion'
           : qualityLevel === 'low'
             ? 'Power saver'
             : 'Balanced';

         return (
           <div className={styles.indicator} role="status" aria-live="polite">
             <span className={styles.icon}>
               {prefersReducedMotion ? '~' : qualityLevel === 'low' ? 'ECO' : '~'}
             </span>
             <span className={styles.label}>{label}</span>
           </div>
         );
       }
       ```

    2. Create src/components/PerformanceIndicator.module.css:
       ```css
       .indicator {
         position: fixed;
         bottom: 16px;
         right: 16px;
         display: flex;
         align-items: center;
         gap: 6px;
         padding: 6px 12px;
         background: var(--color-surface);
         border: 1px solid var(--color-border);
         border-radius: 20px;
         font-size: 0.75rem;
         color: var(--color-text-secondary);
         opacity: 0.7;
         z-index: 1000;
         transition: opacity var(--transition-base);
       }

       .indicator:hover {
         opacity: 1;
       }

       .icon {
         font-weight: bold;
       }

       .label {
         white-space: nowrap;
       }

       @media print {
         .indicator {
           display: none;
         }
       }
       ```

    3. Add PerformanceIndicator to App.tsx:
       - Import: `import { PerformanceIndicator } from './components/PerformanceIndicator';`
       - Add before closing fragment (after </div> that wraps main content):
         ```tsx
         <PerformanceIndicator
           qualityLevel={qualityLevel}
           prefersReducedMotion={prefersReducedMotion}
         />
         ```

    Per CONTEXT.md: Show subtle indicator when performance mode is active.
  </action>
  <verify>
    - PerformanceIndicator.tsx exists and exports PerformanceIndicator
    - PerformanceIndicator.module.css exists with .indicator styles
    - App.tsx imports and renders PerformanceIndicator
    - Indicator appears when qualityLevel is not 'high' or reduced motion is on
    - Indicator hidden when at full quality and no reduced motion
    - Indicator hidden in print view
    - `npm run dev` works
    - `npm run build` succeeds
  </verify>
  <done>
    - PerformanceIndicator component created with CSS module
    - Indicator shows current mode (Reduced motion / Power saver / Balanced)
    - Users informed when experiencing reduced animation
    - Accessibility attributes on indicator (role="status", aria-live)
  </done>
</task>

</tasks>

<verification>
Complete verification sequence:

1. Build verification:
   - `npm run build` succeeds
   - No TypeScript errors

2. FPS wiring verification:
   - Open src/components/Waves.tsx and confirm:
     - WavesPropTypes has `fps?: number`
     - Props destructuring has `fps = 30`
     - useAnimationFrame uses `{ fps, paused }`
   - Open src/App.tsx and confirm:
     - animationParams.fps is defined in useMemo
     - WavyBackground options includes `fps: animationParams.fps`

3. Reduced motion testing:
   - macOS: System Preferences > Accessibility > Display > Reduce motion
   - OR Chrome DevTools > Rendering > Emulate CSS media feature prefers-reduced-motion
   - Waves should animate very slowly (subtle drift)
   - Performance indicator shows "Reduced motion"
   - Parallax effects minimal

4. Adaptive quality testing:
   - Chrome DevTools > Performance > CPU throttling (6x slowdown)
   - After a few seconds, quality should degrade
   - Indicator shows "Power saver" or "Balanced"
   - Fewer waves rendered, lower FPS

5. Lighthouse check:
   - Run Lighthouse on production build
   - Performance score should be 90+ on mobile
   - Accessibility score should remain high
</verification>

<success_criteria>
- useAdaptiveFrameRate hook created and returns quality levels
- utilities.css slows animations instead of disabling for reduced-motion
- Waves.tsx accepts fps prop and passes it to useAnimationFrame
- Waves.tsx uses cachedPerlin2 for memoized noise calculations
- App.tsx integrates both hooks and computes animationParams
- App.tsx passes fps: animationParams.fps to WavyBackground options
- PerformanceIndicator shows when not at full quality
- Reduced motion: waves drift slowly (3fps, 10x slower)
- Low performance: fewer waves (3), lower FPS (15)
- Lighthouse performance 90+ on mobile
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-animation/05-03-SUMMARY.md`
</output>
