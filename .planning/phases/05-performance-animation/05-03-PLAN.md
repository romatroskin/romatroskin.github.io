---
phase: 05-performance-animation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/hooks/useAdaptiveFrameRate.ts
  - src/components/Waves.tsx
  - src/App.tsx
  - src/styles/utilities.css
  - src/components/PerformanceIndicator.tsx
  - src/components/PerformanceIndicator.module.css
autonomous: true

must_haves:
  truths:
    - "Users with prefers-reduced-motion see slow, subtle wave animation (5-10x slower)"
    - "Low-performance devices automatically get simplified animations"
    - "Performance indicator shows when in low-power mode"
    - "Wave animations maintain 30fps on mid-tier mobile devices"
  artifacts:
    - path: "src/hooks/useAdaptiveFrameRate.ts"
      provides: "Frame rate detection and quality level"
      exports: ["useAdaptiveFrameRate"]
    - path: "src/components/PerformanceIndicator.tsx"
      provides: "Visual indicator for performance mode"
      exports: ["PerformanceIndicator"]
    - path: "src/styles/utilities.css"
      provides: "Updated reduced-motion styles (slow instead of disable)"
      contains: "prefers-reduced-motion"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/usePrefersReducedMotion.ts"
      via: "hook call"
      pattern: "usePrefersReducedMotion\\(\\)"
    - from: "src/App.tsx"
      to: "src/hooks/useAdaptiveFrameRate.ts"
      via: "hook call"
      pattern: "useAdaptiveFrameRate\\(\\)"
    - from: "src/components/Waves.tsx"
      to: "animation parameters"
      via: "props from App.tsx"
      pattern: "fps.*paused"
---

<objective>
Implement reduced motion support and adaptive animation quality for smooth performance across all devices.

Purpose: Honor user accessibility preferences and ensure 60fps animations on all hardware.
Output: Reduced motion shows slow drift (5-10x slower), adaptive frame rate adjusts to device capability.
</objective>

<execution_context>
@/Users/romatroskin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/romatroskin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-animation/05-RESEARCH.md
@.planning/phases/05-performance-animation/05-CONTEXT.md

# Relevant source files
@src/hooks/usePrefersReducedMotion.ts (created in 05-01)
@src/hooks/useAnimationFrame.ts
@src/components/Waves.tsx
@src/App.tsx
@src/styles/utilities.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAdaptiveFrameRate hook and update utilities.css</name>
  <files>
    - src/hooks/useAdaptiveFrameRate.ts
    - src/styles/utilities.css
  </files>
  <action>
    1. Create src/hooks/useAdaptiveFrameRate.ts following 05-RESEARCH.md pattern:
       - Track frame times using requestAnimationFrame
       - Keep rolling window of last 60 frame deltas
       - Calculate average FPS every 60 frames
       - Return qualityLevel: 'high' | 'medium' | 'low'
       - Thresholds:
         - < 30fps -> 'low'
         - < 45fps -> 'medium'
         - > 55fps -> recover to higher quality
       - Export useAdaptiveFrameRate(targetFPS = 60)

    2. Update src/styles/utilities.css to SLOW animations instead of disabling:
       - Change existing reduced-motion rule from 0.01ms to longer durations
       - Per CONTEXT.md: use 5-10x slower instead of static

       REPLACE:
       ```css
       @media (prefers-reduced-motion: reduce) {
         *,
         *::before,
         *::after {
           animation-duration: 0.01ms !important;
           animation-iteration-count: 1 !important;
           transition-duration: 0.01ms !important;
           scroll-behavior: auto !important;
         }
       }
       ```

       WITH:
       ```css
       @media (prefers-reduced-motion: reduce) {
         *,
         *::before,
         *::after {
           /* Slow animations 10x instead of disabling (per user preference) */
           animation-duration: 3s !important;
           transition-duration: 0.5s !important;
           /* Keep scroll behavior instant for vestibular users */
           scroll-behavior: auto !important;
         }
       }
       ```

       Note: CSS animations affect micro-interactions. Wave animations (JS-based) are handled in App.tsx.
  </action>
  <verify>
    - File exists: src/hooks/useAdaptiveFrameRate.ts
    - Hook exports useAdaptiveFrameRate
    - utilities.css @media rule updated with longer durations
    - `npm run build` succeeds
  </verify>
  <done>
    - useAdaptiveFrameRate hook detects frame rate and returns quality level
    - CSS micro-interactions slow down 10x for reduced-motion preference
    - No animations completely removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate reduced motion and adaptive quality into App.tsx</name>
  <files>
    - src/App.tsx
  </files>
  <action>
    Update src/App.tsx to use reduced motion and adaptive performance:

    1. Import hooks at top:
       ```typescript
       import { usePrefersReducedMotion } from './hooks/usePrefersReducedMotion';
       import { useAdaptiveFrameRate } from './hooks/useAdaptiveFrameRate';
       ```

    2. Add hooks inside App component:
       ```typescript
       const prefersReducedMotion = usePrefersReducedMotion();
       const qualityLevel = useAdaptiveFrameRate(60);
       ```

    3. Compute animation parameters based on quality and motion preference:
       ```typescript
       // Animation parameters based on performance and accessibility
       const animationParams = useMemo(() => {
         // Reduced motion: 10x slower animation, minimal movement
         if (prefersReducedMotion) {
           return {
             fps: 3,           // Very slow update rate
             speedMultiplier: 0.1,  // 10x slower speed
             numWaves: 3,      // Fewer waves for simplicity
           };
         }

         // Adaptive based on detected frame rate
         switch (qualityLevel) {
           case 'low':
             return {
               fps: 15,
               speedMultiplier: 0.5,
               numWaves: 3,
             };
           case 'medium':
             return {
               fps: 24,
               speedMultiplier: 0.75,
               numWaves: 4,
             };
           case 'high':
           default:
             return {
               fps: 30,
               speedMultiplier: 1,
               numWaves: 5,
             };
         }
       }, [prefersReducedMotion, qualityLevel]);
       ```

    4. Use animationParams.numWaves instead of hardcoded numWaves constant
    5. Pass fps to WavyBackground via options (requires Waves.tsx update)
    6. Apply speedMultiplier to the speed calculations in waveConfigs

    IMPORTANT: Parallax effects should also be reduced. Update ParallaxLayer speed props:
    - For reduced motion: multiply speed by 0.1 (almost static)
    - For low quality: multiply speed by 0.5
  </action>
  <verify>
    - App.tsx imports both hooks
    - animationParams computed based on reduced motion and quality
    - Wave count adjusts based on quality level
    - `npm run dev` shows waves animating
    - Enabling "Reduce Motion" in OS settings changes animation behavior
  </verify>
  <done>
    - Reduced motion users see slow, subtle wave drift
    - Low-performance devices get fewer, slower waves
    - Parallax effects reduced for accessibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Waves component and add PerformanceIndicator</name>
  <files>
    - src/components/Waves.tsx
    - src/components/PerformanceIndicator.tsx
    - src/components/PerformanceIndicator.module.css
    - src/App.tsx
  </files>
  <action>
    1. Update src/components/Waves.tsx to accept dynamic fps:
       - The fps is already passed via options prop to useAnimationFrame
       - Ensure the fps from props is used (it already is via options.fps)
       - No changes needed if fps is already configurable via props

    2. Create src/components/PerformanceIndicator.tsx:
       ```typescript
       import styles from './PerformanceIndicator.module.css';

       interface PerformanceIndicatorProps {
         qualityLevel: 'high' | 'medium' | 'low';
         prefersReducedMotion: boolean;
       }

       export function PerformanceIndicator({ qualityLevel, prefersReducedMotion }: PerformanceIndicatorProps) {
         // Only show when not at full quality
         if (qualityLevel === 'high' && !prefersReducedMotion) {
           return null;
         }

         const label = prefersReducedMotion
           ? 'Reduced motion'
           : qualityLevel === 'low'
             ? 'Power saver'
             : 'Balanced';

         return (
           <div className={styles.indicator} role="status" aria-live="polite">
             <span className={styles.icon}>
               {prefersReducedMotion ? '~' : qualityLevel === 'low' ? 'ECO' : '~'}
             </span>
             <span className={styles.label}>{label}</span>
           </div>
         );
       }
       ```

    3. Create src/components/PerformanceIndicator.module.css:
       ```css
       .indicator {
         position: fixed;
         bottom: 16px;
         right: 16px;
         display: flex;
         align-items: center;
         gap: 6px;
         padding: 6px 12px;
         background: var(--color-surface);
         border: 1px solid var(--color-border);
         border-radius: 20px;
         font-size: 0.75rem;
         color: var(--color-text-secondary);
         opacity: 0.7;
         z-index: 1000;
         transition: opacity var(--transition-base);
       }

       .indicator:hover {
         opacity: 1;
       }

       .icon {
         font-weight: bold;
       }

       .label {
         white-space: nowrap;
       }

       @media print {
         .indicator {
           display: none;
         }
       }
       ```

    4. Add PerformanceIndicator to App.tsx:
       - Import: `import { PerformanceIndicator } from './components/PerformanceIndicator';`
       - Add before closing fragment:
         ```tsx
         <PerformanceIndicator
           qualityLevel={qualityLevel}
           prefersReducedMotion={prefersReducedMotion}
         />
         ```

    Per CONTEXT.md: Show subtle indicator when performance mode is active.
  </action>
  <verify>
    - PerformanceIndicator component created
    - Indicator appears when qualityLevel is not 'high' or reduced motion is on
    - Indicator hidden in print view
    - `npm run dev` works
    - `npm run build` succeeds
  </verify>
  <done>
    - Waves fps adjustable via props
    - Performance indicator shows current mode
    - Users informed when experiencing reduced animation
    - Accessibility attributes on indicator (role="status", aria-live)
  </done>
</task>

</tasks>

<verification>
Complete verification sequence:

1. Build verification:
   - `npm run build` succeeds
   - No TypeScript errors

2. Reduced motion testing:
   - macOS: System Preferences > Accessibility > Display > Reduce motion
   - OR Chrome DevTools > Rendering > Emulate CSS media feature prefers-reduced-motion
   - Waves should animate very slowly (subtle drift)
   - Performance indicator shows "Reduced motion"
   - Parallax effects minimal

3. Adaptive quality testing:
   - Chrome DevTools > Performance > CPU throttling (6x slowdown)
   - After a few seconds, quality should degrade
   - Indicator shows "Power saver" or "Balanced"
   - Fewer waves rendered, lower FPS

4. Lighthouse check:
   - Run Lighthouse on production build
   - Performance score should be 90+ on mobile
   - Accessibility score should remain high
</verification>

<success_criteria>
- useAdaptiveFrameRate hook created and returns quality levels
- utilities.css slows animations instead of disabling for reduced-motion
- App.tsx integrates both hooks and adjusts animation parameters
- PerformanceIndicator shows when not at full quality
- Reduced motion: waves drift slowly (10x slower)
- Low performance: fewer waves (3), lower FPS (15)
- Lighthouse performance 90+ on mobile
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-animation/05-03-SUMMARY.md`
</output>
