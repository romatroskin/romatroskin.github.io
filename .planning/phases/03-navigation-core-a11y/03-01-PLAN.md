---
phase: 03-navigation-core-a11y
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/hooks/useScrollSpy.ts
  - src/hooks/useScrollSpy.test.ts
  - src/App.tsx
  - src/index.html
autonomous: true

must_haves:
  truths:
    - "HTML document has lang attribute for screen readers"
    - "App has semantic landmarks (header, main, section)"
    - "Each section has id attribute and aria-labelledby linking to heading"
    - "Clicking nav links smooth-scrolls to sections (via Parallax.scrollTo)"
  artifacts:
    - path: "src/hooks/useScrollSpy.ts"
      provides: "Intersection Observer-based active section detection"
      exports: ["useScrollSpy"]
    - path: "src/hooks/useScrollSpy.test.ts"
      provides: "Unit tests for useScrollSpy hook"
      min_lines: 30
    - path: "src/App.tsx"
      provides: "Semantic HTML structure with section IDs"
      contains: ["id=\"hero-section\"", "id=\"services-section\"", "id=\"about-section\"", "id=\"main-content\""]
---

<objective>
Install navigation dependencies and create scroll spy infrastructure for active section tracking.

Purpose: Establish the foundation for navigation - scroll spy hook detects which section is visible, semantic landmarks enable screen reader navigation.
Output: useScrollSpy hook with tests, App.tsx updated with landmarks and section IDs, dependencies installed.
</objective>

<execution_context>
@/Users/romatroskin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/romatroskin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-navigation-core-a11y/03-RESEARCH.md

Reference existing code:
@src/App.tsx
@src/components/Header/Header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install focus-trap-react and body-scroll-lock dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the two dependencies identified in research:
```bash
npm install focus-trap-react body-scroll-lock
npm install -D @types/body-scroll-lock
```

These enable:
- focus-trap-react: Focus management for mobile menu (WCAG keyboard support)
- body-scroll-lock: Prevent background scroll when mobile menu is open (iOS Safari compatible)
  </action>
  <verify>
- `npm ls focus-trap-react` shows installed version 11.x
- `npm ls body-scroll-lock` shows installed version 4.x
- `npm run build` succeeds without errors
  </verify>
  <done>Dependencies installed and TypeScript types available</done>
</task>

<task type="auto">
  <name>Task 2: Create useScrollSpy hook with Intersection Observer</name>
  <files>src/hooks/useScrollSpy.ts, src/hooks/useScrollSpy.test.ts</files>
  <action>
Create `src/hooks/useScrollSpy.ts`:
- Accept array of section IDs to observe
- Accept optional IntersectionObserverInit options
- Use rootMargin `-10% 0px -85% 0px` to trigger when section is 10% from top
- Use threshold array `[0, 0.25, 0.5, 0.75, 1]` for granular detection
- Return currently active section ID
- Handle "between sections" by keeping previous active (don't clear to empty)
- Cleanup observer on unmount

Key implementation details from RESEARCH.md Pattern 2:
- Create observer in useEffect
- Loop through sectionIds to observe each element by ID
- On intersection, find entry with highest intersectionRatio
- Store activeId in state, return it

Create `src/hooks/useScrollSpy.test.ts`:
- Mock IntersectionObserver (similar pattern to ResizeObserver mock in setupTests.ts)
- Test: returns empty string initially when no sections observed
- Test: returns section ID when section is intersecting
- Test: disconnects observer on unmount
- Test: re-observes when sectionIds array changes
  </action>
  <verify>
- `npm test -- src/hooks/useScrollSpy.test.ts` passes all tests
- Hook exported correctly: `import { useScrollSpy } from './hooks/useScrollSpy'` resolves
  </verify>
  <done>useScrollSpy hook works with mocked IntersectionObserver in tests</done>
</task>

<task type="auto">
  <name>Task 3: Add semantic landmarks and section IDs to App</name>
  <files>src/App.tsx, src/index.html</files>
  <action>
Update `src/index.html`:
- Add `lang="en"` to `<html>` tag (REQ-A11Y-010)

Update `src/App.tsx`:

1. **Add section IDs to EXISTING container divs** (CRITICAL - must add to actual elements):
   - Add `id="hero-section"` to `<div className="hero-container">` (line ~196)
   - Add `id="services-section"` to `<div className="intro-container">` (line ~230)
   - Add `id="about-section"` to `<div className="about-container">` (line ~262)

2. **Wrap Parallax with main landmark:**
   - Wrap the `<Parallax>` component with `<main id="main-content" role="main">` for skip link target

3. **Add heading IDs for aria-labelledby:**
   - Add `id="hero-heading"` to the `<h1>` in hero-container
   - Add `id="services-heading"` to the `<h2>` in intro-container
   - Add `id="about-heading"` to the `<h2>` in about-container

4. **Wrap container divs with section elements:**
   ```tsx
   <section id="hero-section" aria-labelledby="hero-heading">
     <div className="hero-container">...</div>
   </section>
   ```
   Repeat for services and about sections.

5. **DO NOT integrate useScrollSpy yet** - it will be integrated in Plan 03-04 after testing with Parallax container. Keep existing scroll-based currentPage detection (lines 25-47) which already works correctly.

NOTE: Smooth scrolling already works via `parallaxRef.current?.scrollTo(page)` in the `scrollToPage` callback (line 101-103). React-spring Parallax provides smooth animation by default.
  </action>
  <verify>
- `npm run build` succeeds
- `npm test` passes (existing tests should still work)
- In browser DevTools, verify:
  - `<html lang="en">` attribute present
  - `<main id="main-content">` wrapping Parallax
  - `<section id="hero-section">` with `aria-labelledby="hero-heading"`
  - `<section id="services-section">` with `aria-labelledby="services-heading"`
  - `<section id="about-section">` with `aria-labelledby="about-heading"`
- Click header nav links â†’ page smooth-scrolls to section (already working via scrollToPage)
  </verify>
  <done>App has semantic structure with section IDs and landmarks</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` succeeds without errors
2. `npm test` passes all tests including new useScrollSpy tests
3. Browser inspection shows:
   - `<html lang="en">`
   - `<main id="main-content">`
   - Sections with `id` attributes and `aria-labelledby`
   - Headings with proper IDs
4. Dependencies installed: `npm ls focus-trap-react body-scroll-lock`
</verification>

<success_criteria>
- useScrollSpy hook exists with unit tests passing
- App.tsx has semantic landmarks (main, section with aria-labelledby)
- index.html has lang="en" attribute
- Dependencies focus-trap-react and body-scroll-lock installed
- Build and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-navigation-core-a11y/03-01-SUMMARY.md`
</output>
