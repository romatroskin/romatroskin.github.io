---
phase: 02-component-architecture
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/Waves.tsx
  - src/components/WavyBackground.tsx
  - src/components/Waves.test.tsx
  - src/components/WavyBackground.test.tsx
  - src/components/Header/Header.test.tsx
  - src/App.test.tsx
autonomous: false

must_haves:
  truths:
    - "Wave component renders animated SVG path with Perlin noise"
    - "Wave component is a functional component (no class syntax)"
    - "Animation continues smoothly during scroll interactions"
    - "WavyBackground passes style prop through to Wave for react-spring animation"
    - "App renders without crashing"
    - "Header renders navigation links"
    - "WavyBackground renders SVG element"
  artifacts:
    - path: "src/components/Waves.tsx"
      provides: "Functional Wave component with hooks"
      exports: ["Wave", "WaveProps", "WavesPropTypes"]
    - path: "src/App.test.tsx"
      provides: "Smoke test for App component"
      min_lines: 10
    - path: "src/components/Header/Header.test.tsx"
      provides: "Smoke test for Header component"
      min_lines: 10
    - path: "src/components/WavyBackground.test.tsx"
      provides: "Smoke test for WavyBackground component"
      min_lines: 10
  key_links:
    - from: "src/components/Waves.tsx"
      to: "src/hooks/useAnimationFrame.ts"
      via: "import and hook call"
      pattern: "useAnimationFrame"
    - from: "src/components/Waves.tsx"
      to: "src/hooks/usePerlinNoise.ts"
      via: "import and hook call"
      pattern: "usePerlinNoise"
    - from: "src/components/WavyBackground.tsx"
      to: "src/components/Waves.tsx"
      via: "animated() HOC"
      pattern: "animated\\(Wave\\)"
---

<objective>
Migrate Wave class component to functional component using custom hooks, and add component smoke tests.

Purpose: Complete the class-to-functional refactor for better testability and react-spring integration, with test coverage proving components render correctly.
Output: Functional Wave component with hooks, updated WavyBackground, and smoke tests for App, Header, WavyBackground.
</objective>

<execution_context>
@/Users/romatroskin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/romatroskin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-component-architecture/02-CONTEXT.md
@.planning/phases/02-component-architecture/02-RESEARCH.md
@.planning/phases/02-component-architecture/02-01-SUMMARY.md
@src/components/Waves.tsx
@src/components/WavyBackground.tsx
@src/components/Header/Header.tsx
@src/App.tsx
@src/hooks/useAnimationFrame.ts
@src/hooks/usePerlinNoise.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Wave class to functional component</name>
  <files>src/components/Waves.tsx</files>
  <action>
Rewrite Wave component as a functional component using the custom hooks from Plan 01.

**Lifecycle mapping (class -> hooks):**
- `constructor` -> useState for path, useRef for container, usePerlinNoise hook
- `componentDidMount` -> useEffect with [] for container measurement
- `componentWillUnmount` -> useAnimationFrame handles cleanup
- Instance variables (`_elapsed`, `_step`, `_lastUpdate`, `_frameId`) -> managed by useAnimationFrame
- `_containerWidth`, `_containerHeight` -> useRef

**Key implementation points:**

1. **Component signature:**
   ```typescript
   const Wave = React.forwardRef<HTMLDivElement, WaveProps>(function Wave(props, ref) {
     // ...
   });
   ```

2. **State and refs:**
   ```typescript
   const [path, setPath] = useState("");
   const containerRef = useRef<HTMLDivElement>(null);
   const containerSize = useRef({ width: 0, height: 0 });
   ```

3. **Hooks usage:**
   ```typescript
   const noise = usePerlinNoise(); // Stable Perlin instance

   useAnimationFrame((elapsed) => {
     // Calculate wave points and update path
     const step = (elapsed * Math.PI) / 1000;
     const points = calculateWavePoints(step);
     const newPath = buildPath(points);
     setPath(newPath);
   }, { fps: 30, paused: props.paused });
   ```

4. **Extract helper functions (can be inside component or outside):**
   - `calculateWavePoints(step: number): Point[]` - Convert from class method
   - `buildPath(points: Point[]): string` - Convert from class method

5. **Container measurement in useEffect:**
   ```typescript
   useEffect(() => {
     if (containerRef.current) {
       containerSize.current = {
         width: containerRef.current.offsetWidth,
         height: containerRef.current.offsetHeight
       };
     }
   }, []);
   ```

6. **Props handling for Interpolation values:**
   Keep the `.get()` pattern for Interpolation props (speed, height, amplitude) - this is required for react-spring integration.

7. **Preserve existing exports:**
   ```typescript
   export default Wave;
   export type { WaveProps, WavesPropTypes };
   ```

8. **Default props via defaultProps or destructuring with defaults:**
   ```typescript
   const {
     points = 3,
     speed = 0.1,
     amplitude = 10,
     height = 50,
     paused = false,
     svgId = "wave",
     svgPathId = "wave-path",
     ...rest
   } = props;
   ```

**IMPORTANT:** Forward the style prop to the root div element for react-spring animated() to work.
  </action>
  <verify>
File exists with:
- No `class Wave` syntax
- Uses useAnimationFrame and usePerlinNoise hooks
- Exports Wave, WaveProps, WavesPropTypes
- Forwards ref properly
  </verify>
  <done>Wave is now a functional component using custom hooks</done>
</task>

<task type="auto">
  <name>Task 2: Update WavyBackground for functional Wave</name>
  <files>src/components/WavyBackground.tsx</files>
  <action>
Review and update WavyBackground to work with the functional Wave component.

**Changes needed:**

1. **Update ref type:**
   The current ref type is `Wave` (class instance). Update to `HTMLDivElement` since functional Wave forwards ref to the container div:
   ```typescript
   const WavyBackground = memo(
     React.forwardRef<HTMLDivElement, WavyBackgroundPropTypes>(
       ({ options, style, fill, id }, ref) => {
   ```

2. **Verify animated() still works:**
   The animated() HOC should work with functional components that forward the style prop. No changes needed to AnimatedWave if Wave correctly forwards style.

3. **Clean up type assertion comment:**
   The existing comment about type assertion can remain or be updated to reflect the simpler situation with functional components.

4. **Test that Interpolation props still flow through:**
   The options object with Interpolation values for height, amplitude, speed should continue to work since Wave calls `.get()` on them.

**If no changes are needed after review, document why in a code comment and proceed.**
  </action>
  <verify>
File compiles without TypeScript errors.
Run: `npx tsc --noEmit`
  </verify>
  <done>WavyBackground works with functional Wave component</done>
</task>

<task type="auto">
  <name>Task 3: Component smoke tests</name>
  <files>src/App.test.tsx, src/components/Header/Header.test.tsx, src/components/WavyBackground.test.tsx, src/components/Waves.test.tsx</files>
  <action>
Create smoke tests verifying components render without crashing.

**src/App.test.tsx:**
```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/react';
import App from './App';

// Mock window.matchMedia for usehooks-ts
vi.mock('usehooks-ts', () => ({
  useWindowSize: () => ({ width: 1024, height: 768 })
}));

describe('App', () => {
  it('renders without crashing', () => {
    render(<App />);
    // Verify some content renders
    expect(screen.getByText(/Puff Puff/i)).toBeInTheDocument();
  });

  it('renders Header component', () => {
    render(<App />);
    expect(screen.getByRole('banner')).toBeInTheDocument();
  });
});
```

**src/components/Header/Header.test.tsx:**
```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import Header from './Header';

describe('Header', () => {
  it('renders without crashing', () => {
    render(<Header />);
  });

  it('renders navigation links', () => {
    render(<Header />);
    expect(screen.getByText('Home')).toBeInTheDocument();
    expect(screen.getByText('About')).toBeInTheDocument();
    expect(screen.getByText('Services')).toBeInTheDocument();
    expect(screen.getByText('Contact')).toBeInTheDocument();
  });

  it('renders logo link with aria-label', () => {
    render(<Header />);
    expect(screen.getByLabelText('Puff Puff Dev Home')).toBeInTheDocument();
  });
});
```

**src/components/WavyBackground.test.tsx:**
```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import WavyBackground from './WavyBackground';

describe('WavyBackground', () => {
  it('renders without crashing', () => {
    render(
      <WavyBackground
        options={{
          points: 3,
          speed: 0.1,
          amplitude: 10,
          height: 50,
          paused: true // Pause animation for deterministic test
        }}
      />
    );
  });

  it('renders an SVG element', () => {
    const { container } = render(
      <WavyBackground
        options={{
          points: 3,
          speed: 0.1,
          amplitude: 10,
          height: 50,
          paused: true
        }}
      />
    );
    expect(container.querySelector('svg')).toBeInTheDocument();
  });
});
```

**src/components/Waves.test.tsx:**
```typescript
import { describe, it, expect } from 'vitest';
import { render } from '@testing-library/react';
import Wave from './Waves';

describe('Wave', () => {
  it('renders without crashing', () => {
    render(
      <Wave
        points={3}
        speed={0.1}
        amplitude={10}
        height={50}
        paused={true}
      />
    );
  });

  it('renders SVG with path element', () => {
    const { container } = render(
      <Wave
        points={3}
        speed={0.1}
        amplitude={10}
        height={50}
        paused={true}
      />
    );
    expect(container.querySelector('svg')).toBeInTheDocument();
    expect(container.querySelector('path')).toBeInTheDocument();
  });

  it('uses default props when not provided', () => {
    const { container } = render(<Wave paused={true} />);
    expect(container.querySelector('svg')).toBeInTheDocument();
  });
});
```

**Note:** Use `paused: true` in Wave/WavyBackground tests to prevent animation frame side effects in tests.
  </action>
  <verify>
Run: `npm test -- --run`

All smoke tests pass:
- App.test.tsx: renders without crashing, has header
- Header.test.tsx: renders nav links
- WavyBackground.test.tsx: renders SVG
- Waves.test.tsx: renders SVG with path
  </verify>
  <done>Smoke tests pass for App, Header, WavyBackground, Wave</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Wave component migrated from class to functional component using useAnimationFrame and usePerlinNoise hooks. All component smoke tests pass.
  </what-built>
  <how-to-verify>
1. Start the development server:
   ```bash
   npm run dev
   ```

2. Open http://localhost:5173 in your browser

3. Verify visual parity:
   - Wave animations render at the bottom of the screen
   - Waves move smoothly with organic Perlin noise movement
   - Multiple waves are visible with different colors/positions
   - Waves respond to scroll (height/amplitude change as you scroll)

4. Test scroll interaction:
   - Scroll down the page slowly
   - Waves should scale and transform smoothly
   - No stuttering or glitching
   - Animation continues without interruption

5. Check console for errors:
   - Open browser DevTools (F12)
   - Check Console tab for any errors or warnings
   - There should be no React warnings about class components

6. Verify tests pass:
   ```bash
   npm test -- --run
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if visual parity is confirmed and animations are smooth, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Wave is functional:**
   ```bash
   grep -c "class Wave" src/components/Waves.tsx
   # Should output 0 (no class syntax)
   ```

2. **Hooks are used:**
   ```bash
   grep "useAnimationFrame\|usePerlinNoise" src/components/Waves.tsx
   # Should show import and usage
   ```

3. **All tests pass:**
   ```bash
   npm test -- --run
   ```

4. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```

5. **Dev server works:**
   ```bash
   npm run dev
   # Visit http://localhost:5173 - waves should animate
   ```
</verification>

<success_criteria>
- Wave component is functional (no class syntax)
- Wave uses useAnimationFrame and usePerlinNoise hooks
- WavyBackground works with functional Wave
- Smoke tests pass for App, Header, WavyBackground, Wave
- Visual parity confirmed by human verification
- Animation is smooth during scroll interactions
- No console errors or React warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-component-architecture/02-02-SUMMARY.md`
</output>
