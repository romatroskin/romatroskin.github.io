---
phase: 01-foundation-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - package.json
  - src/setupTests.ts
  - src/components/Perlin.test.tsx
autonomous: true

must_haves:
  truths:
    - "Running npm test executes Vitest and passes"
    - "Perlin noise produces identical output for same seed and coordinates"
    - "Test coverage report is generated"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vitest test configuration"
      contains: "test:"
    - path: "src/setupTests.ts"
      provides: "Test environment setup with jest-dom matchers"
      min_lines: 5
    - path: "src/components/Perlin.test.tsx"
      provides: "Perlin noise determinism tests"
      min_lines: 20
  key_links:
    - from: "vite.config.ts"
      to: "src/setupTests.ts"
      via: "setupFiles configuration"
      pattern: "setupFiles.*setupTests"
    - from: "src/components/Perlin.test.tsx"
      to: "src/components/Perlin.tsx"
      via: "import Perlin class"
      pattern: "import.*Perlin"
---

<objective>
Set up Vitest testing infrastructure with React Testing Library and create unit tests for the Perlin noise algorithm.

Purpose: Establish the testing foundation required for safe refactoring and ongoing code quality. Perlin tests prove the algorithm produces deterministic output for the same seed/coordinates, which is critical for stable wave animations.

Output: Working test runner with passing Perlin noise tests, coverage reporting enabled.
</objective>

<execution_context>
@/Users/romatroskin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/romatroskin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-cleanup/01-RESEARCH.md

@src/components/Perlin.tsx
@vite.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing dependencies</name>
  <files>package.json</files>
  <action>
Install testing dependencies using npm:

```bash
npm install -D vitest jsdom @testing-library/react @testing-library/dom @testing-library/user-event @testing-library/jest-dom @vitest/coverage-v8
```

Add test script to package.json scripts section:
- "test": "vitest"
- "test:coverage": "vitest run --coverage"

Do NOT modify any other package.json fields.
  </action>
  <verify>
Run `npm install` completes without errors.
Run `cat package.json | grep -A2 '"test"'` shows test scripts added.
  </verify>
  <done>Testing packages are installed and npm test script is configured.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest in vite.config.ts</name>
  <files>vite.config.ts</files>
  <action>
Add Vitest configuration to existing vite.config.ts:

1. Add triple-slash reference at top: `/// <reference types="vitest/config" />`
2. Add `test` configuration object to defineConfig:

```typescript
test: {
  globals: true,
  environment: 'jsdom',
  setupFiles: './src/setupTests.ts',
  css: true,
  coverage: {
    provider: 'v8',
    reporter: ['text', 'json', 'html'],
    exclude: ['node_modules/', 'src/setupTests.ts', 'vite.config.ts']
  }
}
```

Preserve all existing config (plugins, base if present).
  </action>
  <verify>
Run `npx tsc --noEmit vite.config.ts` completes without type errors.
  </verify>
  <done>vite.config.ts has valid Vitest configuration with jsdom environment and coverage settings.</done>
</task>

<task type="auto">
  <name>Task 3: Create setupTests.ts with jest-dom matchers</name>
  <files>src/setupTests.ts</files>
  <action>
Create src/setupTests.ts with the following content:

```typescript
import { expect, afterEach } from 'vitest'
import { cleanup } from '@testing-library/react'
import * as matchers from '@testing-library/jest-dom/matchers'

// Extend Vitest's expect with jest-dom matchers
expect.extend(matchers)

// Cleanup after each test to prevent state leakage
afterEach(() => {
  cleanup()
})
```

This enables semantic matchers like `toBeInTheDocument()` and ensures proper test isolation.
  </action>
  <verify>
File exists at src/setupTests.ts with correct imports.
  </verify>
  <done>Test setup file created with jest-dom matchers and automatic cleanup.</done>
</task>

<task type="auto">
  <name>Task 4: Create Perlin noise unit tests</name>
  <files>src/components/Perlin.test.tsx</files>
  <action>
Create src/components/Perlin.test.tsx with determinism tests:

```typescript
import { describe, it, expect } from 'vitest'
import Perlin from './Perlin'

describe('Perlin noise algorithm', () => {
  describe('determinism', () => {
    it('produces identical output for same seed and coordinates', () => {
      const perlin1 = new Perlin(12345)
      const perlin2 = new Perlin(12345)

      // Same seed + same coordinates = identical output
      expect(perlin1.simplex2(3.14, 42)).toBe(perlin2.simplex2(3.14, 42))
      expect(perlin1.perlin2(1.5, 2.5)).toBe(perlin2.perlin2(1.5, 2.5))
    })

    it('produces consistent values across multiple calls', () => {
      const perlin = new Perlin(54321)

      const value1 = perlin.simplex2(5, 5)
      const value2 = perlin.simplex2(5, 5)

      expect(value1).toBe(value2)
    })

    it('produces different output for different seeds', () => {
      const perlin1 = new Perlin(111)
      const perlin2 = new Perlin(222)

      expect(perlin1.simplex2(5, 5)).not.toBe(perlin2.simplex2(5, 5))
    })
  })

  describe('output range', () => {
    it('simplex2 returns values in [-1, 1] range', () => {
      const perlin = new Perlin(99999)

      // Test multiple points to verify range
      for (let i = 0; i < 100; i++) {
        const x = Math.random() * 100
        const y = Math.random() * 100
        const value = perlin.simplex2(x, y)

        expect(value).toBeGreaterThanOrEqual(-1)
        expect(value).toBeLessThanOrEqual(1)
      }
    })

    it('perlin2 returns values approximately in [-1, 1] range', () => {
      const perlin = new Perlin(88888)

      for (let i = 0; i < 100; i++) {
        const x = Math.random() * 100
        const y = Math.random() * 100
        const value = perlin.perlin2(x, y)

        // Perlin2 typically returns values in a slightly smaller range
        expect(value).toBeGreaterThanOrEqual(-1)
        expect(value).toBeLessThanOrEqual(1)
      }
    })
  })

  describe('seed handling', () => {
    it('handles seed value 0', () => {
      const perlin = new Perlin(0)
      const value = perlin.simplex2(1, 1)

      expect(typeof value).toBe('number')
      expect(Number.isFinite(value)).toBe(true)
    })

    it('handles fractional seed values', () => {
      const perlin = new Perlin(0.5)
      const value = perlin.simplex2(1, 1)

      expect(typeof value).toBe('number')
      expect(Number.isFinite(value)).toBe(true)
    })

    it('handles large seed values', () => {
      const perlin = new Perlin(999999999)
      const value = perlin.simplex2(1, 1)

      expect(typeof value).toBe('number')
      expect(Number.isFinite(value)).toBe(true)
    })
  })
})
```

These tests verify:
1. Determinism - same inputs produce same outputs (critical for stable animations)
2. Output range - values stay within expected bounds
3. Edge cases - various seed values work correctly
  </action>
  <verify>
Run `npm test -- --run` and verify all tests pass.
Run `npm run test:coverage` and verify coverage report is generated.
  </verify>
  <done>Perlin noise has comprehensive unit tests proving deterministic behavior and correct output ranges.</done>
</task>

</tasks>

<verification>
1. `npm test -- --run` executes Vitest and all tests pass
2. `npm run test:coverage` generates coverage report
3. Perlin tests demonstrate deterministic output for same seed/coordinates
4. No TypeScript errors in test files
</verification>

<success_criteria>
- npm test command works and shows passing tests
- Perlin.test.tsx contains tests for determinism, output range, and seed handling
- Coverage report shows Perlin.tsx has test coverage
- setupTests.ts correctly extends expect with jest-dom matchers
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cleanup/01-01-SUMMARY.md`
</output>
